# [ 10ì£¼ì°¨ - 1022 ] ìŠ¤í„°ë”” ë‚´ìš©

```bash
    ê¸ˆì¼ ì»¤ë¦¬í˜ëŸ¼
        â”œ 09:00 ~ 12:00 backend í”„ë¡œê·¸ë˜ë° (JPA ê¸°ì´ˆ, JPA í•µì‹¬ êµ¬ì„± ìš”ì†Œ)
        â”” 13:00 ~ 18:00 backend í”„ë¡œê·¸ë˜ë° (JPA í”„ë¡œì íŠ¸ ìƒì„±, EntityManager, JUnit í…ŒìŠ¤íŠ¸)
```

## 1. JPA ê¸°ì´ˆ

> JPA(Java Persistence API)


### JPA(Java Persistence API)

- ìë°” í”Œë«í¼ì˜ **ORM í‘œì¤€ API**
- ìë°” ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ ë§¤í•‘ì„ ì§€ì›í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤


### ORM(Object-Relational Mapping)

- **ORM**ì€ ê°ì²´ ì§€í–¥ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì˜ ê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ ë°ì´í„°ë¥¼ ë§¤í•‘í•˜ëŠ” ê¸°ìˆ 

### ORMì˜ í•µì‹¬ ê°œë…

* **ê°ì²´ ëª¨ë¸** : ìë°” í´ë˜ìŠ¤ë¡œ í‘œí˜„ë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
* **ê´€ê³„í˜• ëª¨ë¸** : í…Œì´ë¸”, ì»¬ëŸ¼, ì™¸ë˜ í‚¤ë¡œ êµ¬ì„±ëœ ë°ì´í„°ë² ì´ìŠ¤
* **ë§¤í•‘** : ê°ì²´ì™€ í…Œì´ë¸”, í•„ë“œì™€ ì»¬ëŸ¼ ê°„ì˜ ëŒ€ì‘ ê´€ê³„
* **ìë™ ë³€í™˜** : SQL ìƒì„±ê³¼ ê²°ê³¼ ë³€í™˜ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬


### JPA ì½”ì–´

* **EntityManager** : JPAì˜ í•µì‹¬ ì¸í„°í˜ì´ìŠ¤ë¡œ, ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬, ì¿¼ë¦¬ ì‹¤í–‰, íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë“±ì„ ë‹´ë‹¹
* **PersistenceContext** : ì—”í‹°í‹°ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ì»¨í…ìŠ¤íŠ¸
* **Transaction** : ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬
* **Entity** : JPAì—ì„œ ê´€ë¦¬í•˜ëŠ” ë°ì´í„° ê°ì²´

### JPA ì½”ì–´ í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
classDiagram
    class EntityManager {
        -persistenceContext: PersistenceContext
        +persist(entity: Entity): void
        +merge(entity: Entity): Entity
        +remove(entity: Entity): void
        +find(class: Class, id: Object): Entity
        +flush(): void
    }

    class PersistenceContext {
        -entities: Map~Object, Entity~
        +addEntity(entity: Entity): void
        +getEntity(id: Object): Entity
        +removeEntity(id: Object): void
        +clear(): void
    }

    class Transaction {
        +begin(): void
        +commit(): void
        +rollback(): void
    }

    class Entity {
        <<Entity>>
        +id: Long
        +data: String
    }

    EntityManager --> PersistenceContext : í¬í•¨
    EntityManager --> Transaction : ì‚¬ìš©
    PersistenceContext --> Entity : ê´€ë¦¬
    EntityManager --> Entity : ì¡°ì‘
```

### JPAì˜ íŠ¹ì§•

* **ê°ì²´ ì§€í–¥ì ** : ìë°” ê°ì²´ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…ì„ ìˆ˜í–‰
* **êµ¬í˜„ì²´ ë…ë¦½ì ** : íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ ë²¤ë”ì— ì¢…ì†ë˜ì§€ ì•ŠìŒ
    - Hibernate, EclipseLink ë“± ë‹¤ì–‘í•œ êµ¬í˜„ì²´ ì§€ì›
* **DBMS ë…ë¦½ì ** : ë‹¤ì–‘í•œ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ì§€ì› (íŠ¹ì • DB ì¢…ì† X)
* **ê°„ì†Œí™”** : ë³µì¡í•œ SQL ì‘ì„± í•„ìš” X, ë°˜ë³µ ì½”ë“œ ê°ì†Œ
* **í‘œì¤€í™”** : ìë°” EE í‘œì¤€ ì‚¬ì–‘ìœ¼ë¡œ, ë‹¤ì–‘í•œ êµ¬í˜„ì²´ ì¡´ì¬ (ì˜ˆ: Hibernate, EclipseLink)



### JPAê³¼ JDBC ì°¨ì´

| êµ¬ë¶„ | JPA | JDBC |
|------|-----|------|
| **ì¶”ìƒí™”** | ë†’ì€ ì¶”ìƒí™” ì œê³µ | ë‚®ì€ ì¶”ìƒí™” ìˆ˜ì¤€ |
| **ê°ì²´ ì§€í–¥** | ê°ì²´ ì¤‘ì‹¬ | ê´€ê³„í˜• ë°ì´í„° ì¤‘ì‹¬ |
| **ì½”ë“œ ì‘ì„±** | SQL ìë™ ìƒì„± | SQL ì§ì ‘ ì‘ì„± |
| **ìƒì‚°ì„±** | ë†’ìŒ (ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ ì œê±°) | ë‚®ìŒ (ë°˜ë³µ ì½”ë“œ ë§ìŒ) |
| **ë°ì´í„° ë³€í™˜** | ìë™ ë§¤í•‘ | ResultSet ìˆ˜ë™ ë§¤í•‘ |
| **íŠ¸ëœì­ì…˜ ê´€ë¦¬** | ë‚´ì¥ íŠ¸ëœì­ì…˜ ê´€ë¦¬ | ìˆ˜ë™ íŠ¸ëœì­ì…˜ ê´€ë¦¬ |
| **DBMS ë…ë¦½ì„±** | ë†’ìŒ (Dialectë¡œ ìë™) | ë‚®ìŒ (DBë³„ SQL) |
| **ìœ ì§€ë³´ìˆ˜** | ì—”í‹°í‹° ë³€ê²½ìœ¼ë¡œ ìë™ | SQL ìˆ˜ì • ì‹œ ì—¬ëŸ¬ ê³³ ë³€ê²½ |

---

## 2. JPAì˜ í•µì‹¬ êµ¬ì„± ìš”ì†Œ


### JPA ì•„í‚¤í…ì²˜

* ğŸ”µ = ì¸í„°í˜ì´ìŠ¤ , ğŸŸ¢ = í´ë˜ìŠ¤

```mermaid
---
config:
  layout: fixed
  theme: redux
---
flowchart TD
 subgraph subGraph0["JPA API"]
        EntityTransaction["ğŸ”µ EntityTransaction<br>â€¢ begin()<br>â€¢ commit()<br>â€¢ rollback()"]
        EntityManagerFactory["ğŸ”µ EntityManagerFactory<br>â€¢ createEntityManager(): EntityManager"]
        EntityManager["ğŸ”µ EntityManager<br>â€¢ persist(Object)<br>â€¢ merge(Object): Object<br>â€¢ remove(Object)<br>â€¢ find(Class, Object): Object"]
  end
 subgraph subGraph1["Hibernate Core"]
        Query["ğŸ”µ Query<br>â€¢ list(): List<br>â€¢ uniqueResult(): Object"]
        Session["ğŸŸ¢ Session<br>â€¢ save(Object)<br>â€¢ get(Object)<br>â€¢ delete(Object)<br>â€¢ createQuery(String): Query"]
        SessionFactory["ğŸŸ¢ SessionFactory<br>â€¢ openSession(): Session"]
        HibernateEntityManager["ğŸŸ¢ HibernateEntityManager<br>â€¢ persist(Object)<br>â€¢ merge(Object): Object<br>â€¢ remove(Object)<br>â€¢ find(Class, Object): Object"]
        HibernateEntityManagerFactory["ğŸŸ¢ HibernateEntityManagerFactory<br>â€¢ createEntityManager(): EntityManager"]
  end
 subgraph subGraph2["MySQL Connector/J"]
        MySQLDriver["ğŸŸ¢ MySQLDriver"]
  end
 subgraph SLF4J["SLF4J"]
        Logger["ğŸ”µ Logger<br>â€¢ info(String)<br>â€¢ warn(String)<br>â€¢ error(String)"]
  end
    EntityManager --> EntityTransaction
    SessionFactory --> Session
    Session -. logs .-> Logger
    Session -. uses .-> MySQLDriver
    HibernateEntityManager -.-> EntityManager
    HibernateEntityManagerFactory -.-> EntityManagerFactory

```

### ì£¼ìš” êµ¬ì„± ìš”ì†Œ

### EntityManagerFactory (class)

```java
EntityManagerFactory emf = 
    Persistence.createEntityManagerFactory("persistenceì˜ ë„¤ì„ê°’");
```

- **ì—­í• ** : EntityManager ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” íŒ©í† ë¦¬ ì—­í• 
- **íŠ¹ì§•** : 
    - ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¹ í•˜ë‚˜ë§Œ ìƒì„±
    - ìŠ¤ë ˆë“œ ì•ˆì „
    - ë¬´ê±°ìš´ ê°ì²´ë¡œ, ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìƒì„±í•˜ê³  ì¢…ë£Œ ì‹œ ë‹«ì•„ì•¼ í•¨



### EntityManager (interface)

```java
// emf - EntityManagerFactory 
EntityManager em = emf.createEntityManager();
// em.parsist(ì—”í‹°í‹°ëª…); 
em.close();
```

- **ì—­í• ** : ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬, ì¿¼ë¦¬ ì‹¤í–‰, íŠ¸ëœì­ì…˜ ê´€ë¦¬
- **íŠ¹ì§•** :
    - ê²½ëŸ‰ ê°ì²´ë¡œ, í•„ìš”í•  ë•Œë§ˆë‹¤ ìƒì„±
    - ìŠ¤ë ˆë“œ ë¹„ì•ˆì „
    - ì‚¬ìš© í›„ ë°˜ë“œì‹œ ë‹«ì•„ì•¼ í•¨

### EntityTransaction (interface)

```java
// em - EntityManager
EntityTransaction tx = em.getTransaction(); 
tx.begin(); // íŠ¸ëœì­ì…˜ start
tx.commit(); // commit ì¢…ë£Œ
// tx.rollback()
```

- **ì—­í• ** : ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ ê´€ë¦¬
- **íŠ¹ì§•** :
    - EntityManagerë¥¼ í†µí•´ íšë“
    - íŠ¸ëœì­ì…˜ ì‹œì‘, ì»¤ë°‹, ë¡¤ë°± ê¸°ëŠ¥ ì œê³µ 
    - ì˜ˆ : begin(), commit(), rollback()


### PersistenceContext (annotation)
```java
@PersistenceContext
private EntityManager entityManager;
```

- **ì—­í• ** : ì—”í‹°í‹° ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” ì»¨í…ìŠ¤íŠ¸
    - ì£¼ë¡œ ì—”í‹°í‹°ë§¤ë‹ˆì € ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ì£¼ì…í•  ë•Œ ì‚¬ìš©
- **íŠ¹ì§•** :
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¼ê³ ë„ ë¶ˆë¦¼
    - ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸° ìƒíƒœ(ë¹„ì˜ì†, ì˜ì†, ì¤€ì˜ì†, ì‚­ì œ)ë¥¼ ê´€ë¦¬
    - 1ì°¨ ìºì‹œ ì—­í•  ìˆ˜í–‰


---


## 3. JPA í”„ë¡œì íŠ¸ ìƒì„±

### intelliJì—ì„œ JPA í”„ë¡œì íŠ¸ ìƒì„±

1. ìš°ì¸¡ìƒë‹¨ -> file -> **New Project** ì„ íƒ
2. **ì„¤ì •ê°’**
    - ì–¸ì–´ : Java
    - íƒ€ì… : Gradle - Groovy
    - JDK : 21
    - Java : 21
    - íŒ¨í‚¤ì§€ : Jar

3. **ì¢…ì†ì„±**
    - Spring Data JPA
    - MySQL Driver
    - Spring Web
    - Lombok

### build.gradle ì˜ì¡´ì„± ì„¤ì •

```groovy
// prev code ...
dependencies {
    implementation 'org.hibernate.orm:hibernate-core:6.6.29.Final'
    implementation 'com.mysql:mysql-connector-j:8.3.0'
    implementation 'jakarta.persistence:jakarta.persistence-api:3.1.0'
    implementation 'org.slf4j:slf4j-api:2.0.17'
    implementation 'ch.qos.logback:logback-classic:1.5.18'
    implementation 'org.slf4j:jul-to-slf4j:2.0.17'

    compileOnly group: 'org.projectlombok', name: 'lombok', version: '1.18.32'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'io.projectreactor:reactor-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}
// next code ...
```

### persistence.xml ì„¤ì •

* **ê²½ë¡œ** : src/main/resources/META-INF/persistence.xml ìƒì„±

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!-- ìŠ¤í‚¤ë§ˆ ë° jpa 2.0ë¡œ ì„ ì–¸ -->
<persistence xmlns="http://java.sun.com/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
             version="2.0">

    <!-- JPA ì„¤ì • -->
    <!-- name -> ntityManagerFactoryë¥¼ ìƒì„±í•  ë•Œ í•´ë‹¹ì´ë¦„ ì‚¬ìš© -->
    <persistence-unit name="lionPU" transaction-type="RESOURCE_LOCAL">
        <provider>org.hibernate.jpa.HibernatePersistenceProvider</provider> <!-- JPA êµ¬í˜„ì²´ë¡œ Hibernate ì‚¬ìš© -->
        <class>org.example.jpa.User</class> <!-- JPA ê´€ë¦¬ ëŒ€ìƒ ì—”í‹°í‹° í´ë˜ìŠ¤ ë“±ë¡ -->

        <properties>
            <!-- DB ì ‘ê·¼ -->
            <property name="jakarta.persistence.jdbc.driver" value="com.mysql.cj.jdbc.Driver"/>
            <property name="jakarta.persistence.jdbc.url" value="jdbc:mysql://localhost:3306/librarydb"/>
            <property name="jakarta.persistence.jdbc.user" value="spring"/>
            <property name="jakarta.persistence.jdbc.password" value="spring1234"/>


            <!--  Hibernate ì„¤ì • -->
            <property name="hibernate.dialect" value="org.hibernate.dialect.MySQLDialect"/> <!-- MySQL ë¬¸ë²• ì§€ì • -->
            <property name="hibernate.hbm2ddl.auto" value="update"/> <!-- ìë™ ìŠ¤í‚¤ë§ˆ ë°˜ì˜  -->
            <!-- 
                # value ì˜µì…˜ ì„¤ëª…
                * create : ê¸°ì¡´í…Œì´ë¸” ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±
                * create-drop : createì™€ ë™ì¼í•˜ì§€ë§Œ, EntityManagerFactory ì¢…ë£Œ ì‹œì ì— í…Œì´ë¸” ì‚­ì œ
                * update : ê¸°ì¡´í…Œì´ë¸” ìœ ì§€, ë³€ê²½ì‚¬í•­ë§Œ ë°˜ì˜ (ê°œë°œì‹œ)
                * validate : ì—”í‹°í‹°ì™€ í…Œì´ë¸”ì´ ì •ìƒ ë§¤í•‘ë˜ì—ˆëŠ”ì§€ í™•ì¸ë§Œ í•¨ (ìš´ì˜ì‹œ)
                * none : ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ  (ê¸°ë³¸ê°’, ìš´ì˜ì‹œ)
            -->

            <property name="hibernate.show_sql" value="true"/> <!-- SQL ì¶œë ¥ -->
            <property name="hibernate.format_sql" value="true"/> <!-- SQL í¬ë§·íŒ… ì¶œë ¥ -->
        </properties>
    </persistence-unit>
</persistence>
```

#### persistence.xml ì£¼ìš” ì„¤ì •ê°’

| ì„¤ì •| ì„¤ëª… | ê°’ |
|---|---|---|
| persistence-unit name | ì„¤ì • ê·¸ë£¹ ì´ë¦„ | UserPU |
| transaction-type | íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë°©ì‹ | RESOURCE_LOCAL (ì§ì ‘ ê´€ë¦¬) |
| provider | JPA êµ¬í˜„ì²´ | Hibernate |
| hibernate.dialect | ë°ì´í„°ë² ì´ìŠ¤ ë°©ì–¸ | MySQLDialect |
| hibernate.hbm2ddl.auto | DDL ìë™ ìƒì„± ì •ì±… | update |
| hibernate.show_sql | SQL ë¡œê·¸ ì¶œë ¥ | true |
| hibernate.format_sql | SQL í¬ë§·íŒ… | true |

#### hibernate.hbm2ddl.auto ì˜µì…˜ ì„¤ëª…

| value | ì„¤ëª… |
|---|---|
| create | ê¸°ì¡´í…Œì´ë¸” ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„± |
| create-drop | createì™€ ë™ì¼í•˜ì§€ë§Œ, EntityManagerFactory ì¢…ë£Œ ì‹œì ì— í…Œì´ë¸” ì‚­ì œ |
| update | ê¸°ì¡´í…Œì´ë¸” ìœ ì§€, ë³€ê²½ì‚¬í•­ë§Œ ë°˜ì˜ (ê°œë°œì‹œ) |
| validate | ì—”í‹°í‹°ì™€ í…Œì´ë¸”ì´ ì •ìƒ ë§¤í•‘ë˜ì—ˆëŠ”ì§€ í™•ì¸ë§Œ í•¨ (ìš´ì˜ì‹œ) |
| none | ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ  (ê¸°ë³¸ê°’, ìš´ì˜ì‹œ) |

---


## 4. JPA - EntityManager

> EntityManager ? ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬, ì¿¼ë¦¬ ì‹¤í–‰, íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë“±ì„ ë‹´ë‹¹í•˜ëŠ” JPAì˜ í•µì‹¬ ì¸í„°í˜ì´ìŠ¤

### EntityManager ìƒì„±

```java
// EntityManagerFactory ìƒì„±
EntityManagerFactory emf = Persistence.createEntityManagerFactory("lionPU");
// EntityManager ìƒì„±
EntityManager em = emf.createEntityManager();
```

### EntityManager ì£¼ìš” ë©”ì„œë“œ

```java
EntityManager em = emf.createEntityManager();
em.getTransaction().begin(); // íŠ¸ëœì­ì…˜ ì‹œì‘
em.persist(entity); 
em.find(Entity.class, id); 
em.remove(entity);
em.merge(entity); 
em.getTransaction().commit(); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
em.close(); // EntityManager ì¢…ë£Œ
```

* **persist(Object entity)** : ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ (INSERT)
* **find(Class<T> entityClass, Object primaryKey)** : ê¸°ë³¸ í‚¤ë¡œ ì—”í‹°í‹° ì¡°íšŒ (SELECT)
* **remove(Object entity)** : ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œê±° (DELETE)
* **merge(Object entity)** : ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³‘í•©
* **getTransaction()** : íŠ¸ëœì­ì…˜ ê°ì²´ íšë“
    - ë©”ì„œë“œ ì œê³µ 
    - .begin() : íŠ¸ëœì­ì…˜ ì‹œì‘
    - .commit() : íŠ¸ëœì­ì…˜ ì»¤ë°‹
    - .rollback() : íŠ¸ëœì­ì…˜ ë¡¤ë°±


### ì—”í‹°í‹° ë¼ì´í”Œ ì‚¬ì´í´

* ì—”í‹°í‹° : JPAì—ì„œ ê´€ë¦¬í•˜ëŠ” ë°ì´í„° ê°ì²´ (domain object)

```mermaid
stateDiagram-v2
    New --> Managed : persist()
    Managed --> Detached : detach() / clear() / close()
    Detached --> Managed : merge()
    Managed --> Removed : remove()
    Managed --> DateBase : flush()
    Removed --> DateBase : flush()
    DateBase --> Managed : merge() JPQL
    state New {
        ë¹„ì˜ì†
    }
    
    state Managed {
        ì˜ì†
    }
    
    state Detached {
        ì¤€ì˜ì†
    }
    
    state Removed {
        ì‚­ì œ
    }
```

* **ë¹„ì˜ì† (New)** : ì—”í‹°í‹° ê°ì²´ê°€ ìƒì„±ë˜ì—ˆì§€ë§Œ, ì•„ì§ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì§€ ì•Šì€ ìƒíƒœ
    - ì¦‰, JPAì™€ ì „í˜€ ê´€ê³„ì—†ì´ ê°ì²´ë§Œ ìƒì„±í•œ ìƒíƒœ
* **ì˜ì† (Managed)** : ì—”í‹°í‹° ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ê´€ë¦¬ë˜ëŠ” ìƒíƒœ
    - ìƒì„±í•œ ê°ì²´ë¥¼ `em.persist()`ë¥¼ í†µí•´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥í•˜ê±°ë‚˜, `em.find()`ë¡œ ì¡°íšŒí•œ ê²½ìš°
* **ì¤€ì˜ì† (Detached)** : ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ë˜ì–´ ë” ì´ìƒ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ìƒíƒœ
    - `em.detach()` ë˜ëŠ” `em.clear()`ë¡œ ë¶„ë¦¬í•˜ê±°ë‚˜, EntityManagerê°€ ì¢…ë£Œëœ ê²½ìš°
* **ì‚­ì œ (Removed)** : ì—”í‹°í‹° ê°ì²´ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì œê±°ëœ ìƒíƒœ
    - `em.remove()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚­ì œëœ ìƒíƒœ


---

## 5. User ì—”í‹°í‹° í´ë˜ìŠ¤

### User ì—”í‹°í‹° í´ë˜ìŠ¤ ì‘ì„±

```java
@Entity // JPAì˜ ì—”í‹°í‹° í´ë˜ìŠ¤ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì–´ë…¸í…Œì´ì…˜
@NoArgsConstructor
@Getter
@Setter
@ToString
@Table(name = "jpa_user") // í•´ë‹¹ 'jpa_user' í…Œì´ë¸”ì—†ìœ¼ë©´ ìë™ìƒì„±ë¨
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY) // pk ìë™ìƒì„± ì „ëµ (1ë¶€í„°)
    private Long id;
    private String name;
    @Column(nullable = false) // email ì»¬ëŸ¼ not null ì œì•½ì¡°ê±´ ì¶”ê°€
    private String email;

    public User(String name, String email) {
        this.name = name;
        this.email = email;
    }
}
```

```sql
-- ìƒì„±ëœ jpa_user í˜•íƒœëŠ” ?
CREATE TABLE jpa_user (
  id BIGINT NOT NULL AUTO_INCREMENT,
  name VARCHAR(255),
  email VARCHAR(255) NOT NULL,
  PRIMARY KEY (id)
) engine=InnoDB;
```

### JPA ì–´ë…¸í…Œì´ì…˜ ê°€ì´ë“œ

#### ì—”í‹°í‹° ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜

| ì–´ë…¸í…Œì´ì…˜ | ì„¤ëª… |
|-----------|------|
| `@Entity` | JPA ì—”í‹°í‹° í´ë˜ìŠ¤ ì„ ì–¸, ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ ë§¤í•‘ |
| `@Table(name = "í…Œì´ë¸”ëª…")` | ë§¤í•‘ë  í…Œì´ë¸” ì´ë¦„ ì§€ì • (ìƒëµ ì‹œ í´ë˜ìŠ¤ëª… ì‚¬ìš©) |

#### ê¸°ë³¸ í‚¤ ê´€ë ¨ ì–´ë…¸í…Œì´ì…˜

| ì–´ë…¸í…Œì´ì…˜ | ì„¤ëª… |
|-----------|------|
| `@Id` | ì—”í‹°í‹°ì˜ ê¸°ë³¸ í‚¤(Primary Key) í•„ë“œ ì§€ì • |
| `@GeneratedValue` | ê¸°ë³¸ í‚¤ ìë™ ìƒì„± ì „ëµ ì„¤ì • |

#### @GeneratedValue ì „ëµ ì˜µì…˜

* `(strategy = GenerationType.ê°’)`

| ì „ëµ | ì„¤ëª… | ì ìš© DB |
|------|------|---------|
| `IDENTITY` | DBì˜ ìë™ ì¦ê°€ ì»¬ëŸ¼ ì‚¬ìš© (AUTO_INCREMENT) | MySQL, SQL Server |
| `SEQUENCE` | DB ì‹œí€€ìŠ¤ ì‚¬ìš© | Oracle, PostgreSQL |
| `TABLE` | ë³„ë„ í…Œì´ë¸”ë¡œ í‚¤ ìƒì„± (ë¹„ì¶”ì²œ) | ëª¨ë“  DB |
| `AUTO` | DBì— ë”°ë¼ ìë™ ì„ íƒ (ê¸°ë³¸ê°’) | ëª¨ë“  DB |

#### @Column ì–´ë…¸í…Œì´ì…˜ ì˜µì…˜

| ì˜µì…˜ | ì„¤ëª… | 
|------|------|
| `nullable = false` | NOT NULL ì œì•½ì¡°ê±´ |
| `length = ìˆ«ì` | ë¬¸ìì—´ ê¸¸ì´ ì œí•œ |
| `unique = true` | ìœ ë‹ˆí¬ ì œì•½ì¡°ê±´ |
| `name = "ì»¬ëŸ¼ëª…"` | ì‹¤ì œ DB ì»¬ëŸ¼ëª… ì§€ì • |
| `insertable = false` | INSERT ì‹œ ì»¬ëŸ¼ ì œì™¸ |
| `updatable = false` | UPDATE ì‹œ ì»¬ëŸ¼ ì œì™¸ |



### persistence.xml ì— ìˆ˜ë™ User ì—”í‹°í‹° ì¶”ê°€

```xml
     <persistence-unit name="lionPU" transaction-type="RESOURCE_LOCAL">
        <provider>org.hibernate.jpa.HibernatePersistenceProvider</provider> 
        <class>org.example.jpa.User</class> <!-- ìš”ê¸° -->
```


### JPA í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

```java 

import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityManagerFactory;
import jakarta.persistence.Persistence;

public class JpaRun {
    public static void main(String[] args) {
        // EntityManagerFactory ? ì„¤ì •ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ EntityManagerë¥¼ ìƒì„±í•˜ëŠ” íŒ©í† ë¦¬
        EntityManagerFactory emf =
                Persistence.createEntityManagerFactory("lionPU");

        // EntityManager ? DBì™€ì˜ ì—°ê²° ë‹´ë‹¹, ì‹¤ì œ ë°ì´í„° ì²˜ë¦¬ëŠ” EntityManagerê°€ ë‹´ë‹¹
        EntityManager em = emf.createEntityManager();
        
        // íŠ¸ëœì­ì…˜ ì‹œì‘
        em.getTransaction().begin();

        // ì…ë ¥ - User ì—”í‹°í‹° ìƒì„± (ë¹„ì˜ì† ìƒíƒœ)
        User user = new User("jung5", "jung5@example.com");

        System.out.println("persist ì „: " + user);

        // ì˜ì† ìƒíƒœë¡œ ì „í™˜ - DBì— ì €ì¥ (INSERT)
        em.persist(user); // new -> managed (ì˜ì†)

        System.out.println("persist í›„: " + user);

        // íŠ¸ëœì­ì…˜ ì»¤ë°‹ - ì‹¤ì œ DBì— ë°˜ì˜
        em.getTransaction().commit();


        System.out.println("-".repeat(10));

        // ì¡°íšŒ
        User findUser1 = em.find(User.class, 1L); // managed (ì˜ì†)
        User findUser2 = em.find(User.class, 1L);
        User findUser3 = em.find(User.class, 1L);

        if(findUser1.equals(findUser2)) System.out.println("ê°™ìŒ");
        else System.out.println("ê°™ì§€ì•ŠìŒ");
        if(findUser1.equals(findUser3)) System.out.println("ê°™ìŒ");
        else System.out.println("ê°™ì§€ì•ŠìŒ");

    }
}

```

```bash
# ì‹¤í–‰ ê²°ê³¼ 
persist ì „: User(id=null, name=jung5, email=jung5@example.com)
Hibernate: 
    insert 
    into
        jpa_user
        (email, name) 
    values
        (?, ?)
persist í›„: User(id=1, name=jung5, email=jung5@example.com)
----------
Hibernate: 
    select
        u1_0.id,
        u1_0.email,
        u1_0.name 
    from
        jpa_user u1_0 
    where
        u1_0.id=?
ê°™ìŒ
ê°™ìŒ
```

### ì—”í‹°í‹° ì‹œí€€ìŠ¤ ì‚¬ìš©

#### ì‹œí€€ìŠ¤(Sequence) ë€?

> ì‹œí€€ìŠ¤ëŠ” DBì—ì„œ ê³ ìœ í•œ ìˆ«ìë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ë…ë¦½ì ì¸ ê°ì²´

* ì£¼ë¡œ ê¸°ë³¸ í‚¤(primary key) ê°’ì„ ìë™ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©
* ì‹œí€€ìŠ¤ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë‚´ì—ì„œ ë…ë¦½ì ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°, ì—¬ëŸ¬ í…Œì´ë¸”ì—ì„œ ê³µìœ  ê°€ëŠ¥

####  ì‹¤í–‰ í•´ë³´ìë©´ ?

```java 
// User ì—”í‹°í‹° í´ë˜ìŠ¤ ...
public class User {
    @Id
    // @GeneratedValue(strategy = GenerationType.IDENTITY)
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    private Long id;
}

// run í´ë˜ìŠ¤ ...
public class JpaRunIns {
    public static void main(String[] args) {
        EntityManagerFactory emf =
                Persistence.createEntityManagerFactory("lionPU");

        EntityManager em = emf.createEntityManager();

        // íŠ¸ëœì­ì…˜ ì‹œì‘
        em.getTransaction().begin();
        System.out.println("ì»¤ë°‹ì „!!!!!");

        User user = new User("jung15", "jung15@example.com");
        System.out.println("persist ì „: " + user);

        em.persist(user);

        System.out.println("persist í›„: " + user);

        // íŠ¸ëœì­ì…˜ ì»¤ë°‹ - ì‹¤ì œ DBì— ë°˜ì˜
        em.getTransaction().commit();
        System.out.println("ì»¤ë°‹í›„!!!!!");
    }
}

```

```bash
# ì‹¤í–‰ ê²°ê³¼
# -- jpa_userê°€ ì•„ë‹Œ jpa_user_SEQ ìœ¼ë¡œ ìƒì„± ì™œ ? 
# - MySQLì€ ì‹œí€€ìŠ¤ ìì²´ ì§€ì› ì•ˆë˜ì„œ ë³„ë„ ë…ë¦½ í…Œì´ë¸”ì„ ë§Œë“¬.
Hibernate: 
    create table jpa_user_SEQ (
        next_val bigint
    ) engine=InnoDB
Hibernate: 
    insert into jpa_user_SEQ values ( 1 )
ì»¤ë°‹ì „!!!!!
persist ì „: User(id=null, name=jung15, email=jung15@example.com)
Hibernate: 
    select
        next_val as id_val 
    from
        jpa_user_SEQ for update
Hibernate: 
    update
        jpa_user_SEQ 
    set
        next_val= ? 
    where
        next_val=?
persist í›„: User(id=1, name=jung15, email=jung15@example.com)
Hibernate: 
    insert 
    into
        jpa_user
        (email, name, id) 
    values
        (?, ?, ?)
ì»¤ë°‹í›„!!!!!
```

#### ì‹œí€€ìŠ¤ë‘ ì•„ì´ë´í‹°í‹° ì°¨ì´ì 

1. **ìƒì„± ì‹œì **
    - IDENTITY : INSERT ì‹œì ì— ê°’ì´ ìƒì„±
    - SEQUENCE : INSERT ì „ì— ë¯¸ë¦¬ ê°’ì´ ìƒì„±

2. **ì„±ëŠ¥**
    - IDENTITY : ë§¤ INSERTë§ˆë‹¤ DBì™€ í†µì‹  í•„ìš” (ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥)
    - SEQUENCE : ë¯¸ë¦¬ ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆì–´ ì„±ëŠ¥ ìš°ìˆ˜

3. **í˜¸í™˜ì„±**
    - IDENTITY : MySQL, SQL Server ë“±ì—ì„œ ì§€ì›
    - SEQUENCE : Oracle, PostgreSQL ë“±ì—ì„œ ì£¼ë¡œ ì‚¬ìš©

4. **ì‚¬ìš© ìš©ë„**
    - IDENTITY : ê°„ë‹¨í•œ ê¸°ë³¸ í‚¤ ìƒì„±ì— ì í•©
    - SEQUENCE : ë³µì¡í•œ í‚¤ ìƒì„± ë¡œì§ì— ìœ ë¦¬ (ì˜ˆ: ì—¬ëŸ¬ í…Œì´ë¸”ì—ì„œ ê³µìœ )

---

## 6. IDENTITY DML ë° merge í…ŒìŠ¤íŠ¸


### ì—”í‹°í‹° - Product í´ë˜ìŠ¤ ìƒì„±

```java
@Entity
@Getter
@Setter
@ToString
@AllArgsConstructor
@NoArgsConstructor
@Table (name = "products")
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    private int price;

    public Product(String name, int price) {
        this.name = name;
        this.price = price;
    }
}
```

### persistence.xml ì— ìˆ˜ë™ Product ì—”í‹°í‹° ì¶”ê°€

```xml
<class>org.example.jpa.Product</class>
```


### DML , merge í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

```java

public class ProductRun {
    public static void main(String[] args) {
        EntityManagerFactory emf =
                Persistence.createEntityManagerFactory("lionPU");

        // ì—”í‹°í‹° ë§¤ë‹ˆì € 1
        EntityManager em1 = emf.createEntityManager();
        em1.getTransaction().begin();

        Product p1 = new Product("ì‚¬ê³¼", 9900); // new (ë¹„ì˜ì†)
        Product p2 = new Product("ë°”ë‚˜ë‚˜", 19800);
        Product p3 = new Product("ë”¸ê¸°", 29800);

        // insert
        em1.persist(p1);  // ì´ ì‹œì ë¶€í„° p1ì€ managed (ì˜ì†)
        em1.persist(p2);
        em1.persist(p3);

        // select
        Product getP1 = em1.find(Product.class, p1.getId()); // managed (ì˜ì†)
        Product getP2 = em1.find(Product.class, p2.getId());
        Product getP3 = em1.find(Product.class, p3.getId());

        // update
        getP1.setPrice(100); // êº¼ë‚´ì„œ ê°€ëŠ¥
        getP2.setPrice(200);
        p3.setPrice(300); // p3 ì´ë¯¸ ì˜ì† ìƒíƒœë¡œ ë°˜ì˜ ê°€ëŠ¥

        // deleate
        em1.remove(getP1);

        System.out.println("getP2: " + getP2);
        System.out.println("getP3: " + getP3);

        em1.getTransaction().commit();
        em1.close(); // p1,p2,p3 ì¤€ì˜ì† ë³€ê²½ë¨

        // ----------------------------------------
        System.out.println("-".repeat(10));
        // ì—”í‹°í‹° ë§¤ë‹ˆì € 2
        EntityManager em2 =  emf.createEntityManager();
        em2.getTransaction().begin();

        // ì´ì „ ì¤€ì˜ì† ì—”í‹°í‹° ê°’ ìˆ˜ì •
        System.out.println("ìˆ˜ì • ì „ p2: " + p2);
        p2.setName("ìƒ¤ì¸ë¨¸ìŠ¤ì¼“");
        p2.setPrice(1);

        Product mergeP2 = em2.merge(p2); // ìˆ˜ì •ê°’ ë°˜ì˜ -> ì˜ì†ì „í™˜
        System.out.println("merge í›„ p2: " + mergeP2);

        em2.getTransaction().commit();
        em2.close();
    }
}
```

```bash
# ì‹¤í–‰ ê²°ê³¼
Hibernate: 
    create table products (
        id bigint not null auto_increment,
        name varchar(255),
        price integer not null,
        primary key (id)
    ) engine=InnoDB
Hibernate: # ... // insert [p1]
Hibernate: # ... // insert [p2]
Hibernate: # ... // insert [p3]
getP2: Product(id=2, name=ë°”ë‚˜ë‚˜, price=200)
getP3: Product(id=3, name=ë”¸ê¸°, price=300)
Hibernate: # ... // delete [p1]
Hibernate: # ... // commit
----------
ìˆ˜ì • ì „ p2: Product(id=2, name=ë°”ë‚˜ë‚˜, price=200)
Hibernate: # ... // select [p2]
merge í›„ p2: Product(id=2, name=ìƒ¤ì¸ë¨¸ìŠ¤ì¼“, price=1)
Hibernate: # ... // commit
```

---


## 6. JUnit í…ŒìŠ¤íŠ¸

> JUnit ? ìë°” í”„ë¡œê·¸ë˜ë° ì–¸ì–´ìš© ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬

* JUnitì€ ìë°” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê°œë³„ ë‹¨ìœ„(ë©”ì„œë“œ ë˜ëŠ” í´ë˜ìŠ¤)ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë ˆì„ì›Œí¬
* JUnitì€ í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œ(TDD)ì„ ì§€ì›í•˜ë©°, ê°œë°œìê°€ ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ì „ì— í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ë¨¼ì € ì‘ì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤Œ


### JUnit í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°

#### í…ŒìŠ¤íŠ¸ í•  ëŒ€ìƒ Class

* main/java/org/example/junitexam/Calculator.java

```java
package org.example.junitexam;

public class Calculator {

    public int add(int a, int b) {
        return a + b + 1; // ì¼ë¶€ëŸ¬ í‹€ë¦¬ê²Œ
    }

    public int subtract(int a, int b) {
        return a - b;
    }

    public int multiply(int a, int b) {
        return a * b;
    }

    public int divide(int a, int b) {
        if (b == 0) {
            throw new IllegalArgumentException("0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        }
        return a / b;
    }
}
```

#### í…ŒìŠ¤íŠ¸ class ìƒì„±

* test/java/org/example/junitexam/CalculatorTest.java

```java
package org.example.junitexam;

import org.junit.jupiter.api.*;
import static org.junit.jupiter.api.Assertions.*; // í´ë˜ìŠ¤ë¹¼ê³  ìŠ¤íƒœí‹± ë©”ì„œë“œë§Œ ì‚¬ìš©

// ë©”ì„œë“œ ì˜¤ë” ì ìš© (ìˆœì„œ ë¹„ë³´ì¥, @Order ëª…ì‹œëœ ê²ƒ ìš°ì„ )
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
public class CalculatorTest {
    Calculator calc;

    @BeforeAll // í…ŒìŠ¤íŠ¸ ì²˜ìŒ ì‹œì‘ë  ë•Œ 1ë²ˆ
    static void beforeAll() { }
    
    @AfterAll // ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¢…ë£Œë  ë•Œ 1ë²ˆ
    static void afterAll() { }

    @BeforeEach // ê° @Test ë³„ ì‹¤í–‰ë  ë•Œ 
    public void setUp() {
        calc = new Calculator();
    }

    @AfterEach // ê° @Testë³„ ì¢…ë£Œë  ë•Œ
    public void tearDown() { }

    @Test // í…ŒìŠ¤íŠ¸ ì„ ì–¸
    @DisplayName("add() í…ŒìŠ¤íŠ¸") // í…ŒìŠ¤íŠ¸ ëª… ë³€ê²½
    public void add() {
        int result = calc.add(1,2);
        assertEquals(3, result); // ì˜ˆì¸¡ê°’, ê²°ê³¼ê°’
    }

    @Test
    @DisplayName("subtract() í…ŒìŠ¤íŠ¸")
    public void subtract() {
        int result = calc.subtract(5,2);
        assertEquals(3, result);
    }

    @Test
    @DisplayName("multiply() í…ŒìŠ¤íŠ¸")
    @Order(1) // í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìˆœì„œ
    public void multiply() {
        assertEquals(10, calc.multiply(5,2));
        assertEquals(20, calc.multiply(10,2));
    }


    @Test
    @DisplayName("divide() í…ŒìŠ¤íŠ¸")
    public void divide() {
        assertEquals(5, calc.divide(10,2));
        
        // ì˜ˆì™¸ì²˜ë¦¬ í™•ì¸ì‹œ
        IllegalArgumentException e = assertThrows(
                IllegalArgumentException.class,
                () -> calc.divide(10, 0)
        );
    }
}
```

#### ì‹¤í–‰ ê²°ê³¼


![alt text](../../../assets/img/1022_test.png)